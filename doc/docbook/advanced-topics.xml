<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V5.0//EN"
                 "http://www.docbook.org/xml/5.0/dtd/docbook.dtd" [
  <!ENTITY % local SYSTEM "local-entities.ent">
  <!ENTITY % custom SYSTEM "custom-entities.ent">
  %local;
  %custom;
]>
<chapter xml:id="chapter.advanced-topics" version="5.0"
         xmlns="http://docbook.org/ns/docbook"
         xmlns:c2="http://www.carrot2.org">
  <title>Advanced topics</title>
  <subtitle>Customizing &C2; components and applications</subtitle>

  <para>
    This chapter discusses more advanced usage scenarios of &C2; such as building &C2; from
    source code, fine-tuning clustering or customizing &C2; applications.
  </para>
  
  <section xml:id="section.advanced-topics.building-from-source-code">
    <title>Building &C2; from source code</title>
    
    <para>
      &NA;
    </para>
    
    <section>
      <title>Building &WA;</title>
      
      <para>
        &NA;
      </para>
    </section>
  </section>
  
  <section xml:id="section.advanced-topics.fine-tuning">
    <title>Fine-tuning &C2; clustering</title>
    
    <para>
      This section discusses a number of typical fine-tuning scenarios for &C2; clustering
      algorithms. Some of the scenarios are relevant to all &C2; algorithms, while others
      are specific to individual algorithms.
    </para>
    
    <section xml:id="section.advanced-topics.fine-tuning.stop-words">
      <title>Modifying the list of stop words</title>
      
      <para>
        Stop words are the common meaningless words, such as <emphasis>the</emphasis>, 
        <emphasis>to</emphasis>, <emphasis>for</emphasis> in English, that should be 
        ignored while clustering. The Lingo algorithm, for example, will not create
        clusters whose labels start or end in a stop word.
      </para>
      
      <para>
        To fine-tune the stop words list you can use the 
        <link linkend="section.workbench">&DCW;</link> in the following way:
      </para>
      
      <orderedlist>
        <listitem>
          <para>
            Start &DCW; and run some query on which you'll be observing the results
            of your changes.
          </para>
        </listitem>
        
        <listitem>
          <para>
            Go to the <filename>workspace/</filename> directory which is located in
            the directory to which you extracted &DCW;. Modify the <filename>stopwords.*</filename>
            file for the language you are working on (e.g. <filename>stopwords.en</filename>
            for English). Add or remove stop words as required and save changes.
          </para>
        </listitem>
        
        <listitem>
          <para>
            Open the <guilabel>Attributes</guilabel> view in &DCW; and use the view's toolbar
            button shown in <xref linkend="figure.preprocessing-attributes" /> 
            to group the attributes by semantics. In the <guilabel>Preprocessing</guilabel>
            make sure the <guilabel>Processing language</guilabel> is correctly set and
            check the <guilabel>Reload stopwords</guilabel> checkbox. Doing the latter
            will let you to see the updated clustering results without restarting &DCW;
            every time you save the changed stop word list.
          </para>
        </listitem>
        
        <listitem>
          <para>
            Uncheck the <guilabel>Restart Processing Automatically</guilabel>
            option in the <guilabel>Search</guilabel> menu. To rerun clustering after
            you've saved changes to the <filename>stopwords.*</filename>, choose the
            <guilabel>Restart Clustering</guilabel> option from the <guilabel>Search</guilabel>
            menu, or press <guilabel>Ctrl+F11</guilabel>.
          </para>
        </listitem>
      </orderedlist>
      
      <figure xml:id="figure.preprocessing-attributes">
        <title>&DCW; Preprocessing Attributes</title>
        <mediaobject>
          <imageobject role="html">
            <imagedata format="PNG" fileref="img/workbench-preprocessing-attributes.png" />
          </imageobject>
        </mediaobject>  
      </figure>
      
      <tip>
        <para>
          To transfer the changed stop words file to other &C2; applications, update
          the existing stop words file in the <filename>carrot2-core.jar</filename> the application
          is using. In case of the &DCS; and &WA;, the <filename>carrot2-core.jar</filename> is located
          in the <filename>WEB-INF/lib</filename> directory.
        </para>
      </tip>
    </section>
    
    <section xml:id="section.advanced-topics.fine-tuning.stop-regexps">
      <title>Excluding specific clusters from results</title>
      
      <para>
        The Lingo clustering algorithm, in addition to 
        <link linkend="section.advanced-topics.fine-tuning.stop-words">stop words editing</link>,
        offers more precise control over cluster labels by means of "stop label" regular expressions. 
        If a cluster's label matches one of the stop labels, the label will not appear 
        on the list of clusters produced by Lingo.
      </para>
      
      <para>
        The procedure for tuning stop labels and transferring them to other &C2; applications is similar to 
        <link linkend="section.advanced-topics.fine-tuning.stop-words">stop word tuning</link>.
        The difference is that this time you need to edit the <filename>stoplabels.*</filename> files.
        Each line of a stop labels file corresponds to one stop label and is a <link xlink:href="http://java.sun.com/j2se/1.4.2/docs/api/java/util/regex/Pattern.html">Java regular
        expression</link>. Please note that in order to be removed a label <emphasis>as a whole</emphasis> must match 
        at least one of the stop label expressions. A number of example
        stop label expressions are shown below.
      </para>
      
      <programlisting>(?i)new
(?i)information
(?i)information (about|on).*
(?i)(index|list) of.*</programlisting>

      <para>
        All stop labels shown above start with the <tag>(?i)</tag> prefix, which enables 
        case-insensitive matching for them. The stop label in the first line suppresses 
        labels consisting solely of the word <emphasis>new</emphasis>. Similarly, the stop label
        in the second line removes labels consisting of the word <emphasis>information</emphasis>.
        The stop label in the third line removes labels that start in <emphasis>information about</emphasis>
        or <emphasis>information on</emphasis>, and the stop label in the fourth line removes
        labels that start with <emphasis>index of</emphasis> or <emphasis>list of</emphasis>. 
      </para>
      
      <note>
        <para>
          Please note that defining a very large number of stop labels (100+) may 
          significantly slow down clustering. In such cases you may want to combine
          separate stop label expressions into one larger regular expression.
        </para>
      </note>
    </section>
    
    <section xml:id="section.advanced-topics.fine-tuning.reducing-other-topics">
      <title>Reducing the size of the <emphasis>Other Topics</emphasis> cluster</title>
      
      <para>
        The <emphasis>Other Topics</emphasis> cluster contains documents that do not belong
        to any other cluster generated by the algorithm. Depending on the input documents, the size of
        this cluster may vary from a few to tens of documents.
      </para>
      
      <para>
        By tuning parameters of the clustering algorithm, you can reduce the number of
        unclustered documents, however bringing the number down to 0 is unachievable in most cases.
        Please note that minimizing the <emphasis>Other Topics</emphasis> cluster size is usually achieved
        by forcing the algorithm to create more clusters, which may degrade the perceived
        clustering quality.
      </para>
      
      <tip>
        <para>
          The easiest way to try different clustering algorithm settings is to use
          the <link linkend="section.workbench">&DCW;</link>.
        </para>
      </tip>
      
      <section>
        <title>Tuning Lingo algorithm for smallest <emphasis>Other Topics</emphasis> cluster</title>

        <para>
          To reduce the size of the <emphasis>Other Topics</emphasis> cluster generated
          by Lingo, you can try applying the following settings:
        </para>
        
        <orderedlist>
          <listitem>
            <para>
              Change the <link linkend="LingoClusteringAlgorithm.factorizationFactory" role="attribute" /> attribute
              to <classname>LocalNonnegativeMatrixFactorizationFactory</classname>.
            </para>
          </listitem>
          
          <listitem>
            <para>
              Increase the <link linkend="LingoClusteringAlgorithm.desiredClusterCountBase" role="attribute" />
              above the default value.
            </para>
          </listitem>
          
          <listitem>
            <para>
              Decrease the <link linkend="LingoClusteringAlgorithm.phraseLabelBoost" role="attribute" />.
              Note that this will increase the number of one-word labels, which may not always
              be desirable.
            </para>
          </listitem>
        </orderedlist>
      </section>
    </section>
  </section>
  
  <section xml:id="section.advanced-topics.http-proxies">
    <title>Working with HTTP proxies</title>
    
    <para>
    If your server or development machine connects to HTTP servers via a HTTP
    proxy, you can most of &C2; document source implementations
    to take this information into account by defining the following global
    system properties:
    </para>

    <variablelist>
      <varlistentry>
        <term>http.proxyhost</term>
        <listitem><para>URL of the HTTP proxy (numeric or full address, but
        without the port number).</para></listitem>
      </varlistentry>
  
      <varlistentry>
        <term>http.proxyport</term>
        <listitem><para>Proxy server's port number.</para></listitem>
      </varlistentry>
    </variablelist>
    
    <para>
      Two sources that currently do not support the above properties are: 
      MicrosoftLiveDocumentSource and OpenSearchDocumentSource.
    </para>
    
    <note>
      <para>Password-based authentication is not supported at the moment.
      You can alter the source code to change this 
      in the <filename>HttpUtils</filename> class.</para>
    </note>
  </section>
  
  <section xml:id="section.advanced-topics.customizing-applications">
    <title>Customizing &C2; applications</title>
    
    <section xml:id="section.advanced-topics.customizing-applications.adding-source-to-webapp">
      <title>Adding document source tabs to &WA;</title>
      
      <para>
        Adding a document source tab to the &WA; requires a number of steps. The following
        procedure demonstrates the process on an example of 
        <link role="javadoc" linkend="org.carrot2.source.lucene.LuceneDocumentSource" />. 
      </para>
      
      <orderedlist>
        <listitem>
          <para>
            Download <c2:webapp-download-link>&WA; WAR file</c2:webapp-download-link>.
          </para>
        </listitem>
      
        <listitem>
          <para>
            Open for editing the <filename>suite-webapp.xml</filename> file, located in the 
            <filename>WEB-INF/classes/carrot2-default</filename> directory of the 
            WAR file. To the <tag>sources</tag> section add a fragment shown in
            <xref linkend="figure.lucene-source-descriptor" />.
          </para>

          <figure xml:id="figure.lucene-source-descriptor">
            <title>Lucene document source descriptor</title>
            <programlisting><![CDATA[<source id="lucene" 
    attribute-sets-resource="/carrot2-default/lucene.attributes.xml"
    component-class="org.carrot2.source.lucene.LuceneDocumentSource">
  <label>Lucene</label>
  <title>Lucene</title>
  <mnemonic>L</mnemonic>
  <description>Lucene search</description>
  <example-queries>
    <example-query>query1</example-query>
    <example-query>query2</example-query>
  </example-queries>
</source>]]></programlisting>      
          </figure>
        </listitem>
        
        <listitem>
          <para>
            In the <filename>WEB-INF/classes/carrot2-default</filename> directory of the 
            WAR file create a file names <filename>lucene.attributes.xml</filename>, which 
            will provide all the necessary configuration for the Lucene index
            (see <xref linkend="figure.lucene-source-attributes" />).
          </para>

          <figure xml:id="figure.lucene-source-attributes">
            <title>Lucene document source attributes</title>
            <programlisting><![CDATA[<attribute-sets>
  <attribute-set id="lucene">
    <value-set>
      <label>Lucene</label>
      <attribute key="LuceneDocumentSource.directory">
        <value>
           <wrapper class="org.carrot2.source.lucene.FSDirectoryWrapper">
              <indexPath>/path/to/lucene/index/directory</indexPath>
           </wrapper>
        </value>
      </attribute>
      <attribute key="org.carrot2.source.lucene.SimpleFieldMapper.contentField">
        <value type="java.lang.String" value="summary" />
      </attribute>
      <attribute key="org.carrot2.source.lucene.SimpleFieldMapper.titleField">
        <value type="java.lang.String" value="title" />
      </attribute>
      <attribute key="org.carrot2.source.lucene.SimpleFieldMapper.urlField">
        <value type="java.lang.String" value="url" />
      </attribute>
    </value-set>
  </attribute-set>
</attribute-sets>]]></programlisting>      
          </figure>
        </listitem>

        <listitem>
          <para>
            Deploy the WAR file with the above modifications to your container.
            If the Lucene tab is not showing, clear cookies for the domain on which
            the web application is deployed.
          </para>
        </listitem>        
      </orderedlist>
    </section>
    
    <section xml:id="section.advanced-topics.customizing-applications.customizing-lingo-for-webapp">
      <title>Customizing Lingo for the &WA;</title>
        
      <para>
        To run the &WA; with custom <link linkend="section.component.lingo">attributes of the Lingo clustering algorithm</link>,
        you will need to pass them in a special XML file and reference the file in the
        processing component suite XML the web application is using.
      </para>
      
      <orderedlist>
        <listitem>
          <para>
            Use <link linkend="section.workbench">&DCW;</link> to tune the attributes of Lingo
            to produce the desired results.
          </para>
        </listitem>
        
        <listitem>
          <para>
            Modify the <classname>SavingAttributeValuesToXml</classname> class from the
            <classname>carrot2-examples</classname> package to correspond to the attribute values
            you would like to set for Lingo. Run the class to print the XML encoding of the 
            attribute values to the standard output. The label and identifier
            of the attribute can be set to any value, if there is only one attribute
            set in the file, it will be loaded as the default.
          </para>
          
          <para>  
            Save the result to a local file named
            e.g. <filename>lingo.attributes.xml</filename> and copy the file to the
            <filename>WEB-INF/classes/carrot2-default</filename> directory of the 
            web application's WAR file. 
          </para>
        </listitem>
        
        <listitem>
          <para>
            Open for editing the <filename>suite-common.xml</filename> file, located in the 
            <filename>WEB-INF/classes/carrot2-default</filename> directory of the 
            web application's WAR file. Modify the Lingo entry
            to point to the custom attributes file:
          </para>
          
          <figure xml:id="figure.lingo-algorithm-descriptor">
            <title>Lingo clustering algorithm descriptor</title>
            <programlisting><![CDATA[<algorithm id="lingo" 
    attribute-sets-resource="/carrot2-default/lingo.attributes.xml"
    component-class="org.carrot2.clustering.lingo.LingoClusteringAlgorithm">
  <label>Lingo</label>
  <title>Lingo Clustering</title>
</algorithm>]]></programlisting>      
          </figure>
        </listitem>

        <listitem>
          <para>
            Deploy the WAR file with the above modifications to your container. Lingo
            clustering should be performed with the modified settings for all document
            sources.
          </para>
        </listitem>        
      </orderedlist>
      
      <para>
        You can use the same procedure to customize other algorithms, e.g. 
        <link linkend="section.component.stc">STC</link>.
      </para>
    </section>
    
    <section>
      <title>Adding document sources to &DCW;</title>
      
      <para>
        &NA;
      </para>
    </section>
  </section>
  
  <section xml:id="section.advanced-topics.native-matrix-computations">
    <title>Enabling native matrix computations</title>
    
    <para>
      To speed up clustering performed by the Lingo algorithm, you can
      configure &C2; to use a native platform-specific matrix computation
      library. Depending on the platform, you may see up to a 400% speed-up
      compared to the Java-only mode.
    </para>
    
    <para>
      To enable native matrix computations for &C2;:
    </para>

    <orderedlist>
      <listitem>
        <para>
          <link xlink:href="http://download.carrot2.org/nni/">Download</link> precompiled 
          libraries for your platform and extract the archive to some local directory. 
        </para>
        
        <note>
          <para>
            If no distribution matches your platform, and you would like to
            compile your own version, please ask on the mailing list for
            instructions. You can also try the PIII (Pentium III) versions, which
            seem to work quite well on modern processors as well (e.g. Core2 Duo).
          </para>
        </note>
      </listitem>

      <listitem>
        <para>
          Add an additional option to your JVM command line invocation providing the 
          path to the <emphasis role="bold">directory</emphasis> to which you extracted the native library:
        </para>
        <programlisting><![CDATA[java -Djava.library.path=[native-lib-dir-path] ...]]></programlisting>
      </listitem>

      <listitem>
        <para>
          When &C2; correctly loads the native library, upon initialization of the Lingo
          clustering algorithm, the following entry should appear in application logs:
        </para>
        <programlisting><![CDATA[INFO org.carrot2.clustering.lingo.LingoClustering
Algorithm: Native BLAS routines available]]></programlisting>
      </listitem>
    </orderedlist>
  </section>
</chapter>
